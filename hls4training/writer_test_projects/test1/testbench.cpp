#include "myproject.h"
#include <stdio.h>
#include <math.h>

#define DEBUG true

int main () {

    // INITIALIZE INPUTS
    input_t input [10] = {0.7143839662942416,0.4280236614100781,0.7557614452257732,0.1864172608149517,0.3958371580480593,0.48922538465347165,0.8556268246229701,0.2756100507717756,0.9060124050985038,0.2649863848949727};

    layer0_weight_t layer0_weight [11][10] = {
                    {0.29311767664488797,-0.8745216063746084,-0.16500000634767642,-0.34951014743756637,0.2680795774412579,0.5530888189131411,0.3270491519711538,0.44671013782455415,-0.2001133517407021,0.6698349468729468},
                    {-0.7103830321196598,-0.7974760429571848,0.7376899793838869,0.048398747883065196,-0.11055986895498271,-0.29422068697800596,0.9524068593916868,-0.8127123143729951,0.2176563655544217,0.046718392196655634},
                    {0.3460514076871555,0.9267340675946887,0.4719579499552249,0.23129188436338222,-0.23421942358206493,0.4719673112151821,0.5390906493976002,-0.9064506643278583,-0.900394333319058,-0.3372066902148356},
                    {0.7085860602746263,-0.23530238637200473,-0.6675819602960837,0.21273009040320212,-0.05594233651942182,-0.9911560073679078,-0.34224902448454975,-0.955234132786047,0.2480182638352888,0.2500941645914989},
                    {-0.30092604002218826,-0.3716749118355589,-0.6911634282354462,-0.13350666248781717,-0.9506920281625479,0.157560329170084,-0.8299487472438289,0.32805874092261633,-0.3756507669555438,-0.1547588155039883},
                    {0.8999171073716175,-0.23373409679921098,-0.23703757326630104,-0.29509384232260993,-0.9657863345884612,0.03848731397219174,-0.5618619167405079,-0.9817167621360385,-0.44208876983288503,-0.4465200348601046},
                    {-0.30703283751908583,-0.12719970055693897,0.5839777860425772,0.3521936723371064,0.3879854248697281,0.4766916629040201,0.805827950186945,-0.9135978117066361,-0.8215382481977827,0.7669131223477266},
                    {0.6944064702814094,-0.7316995199248277,-0.03907582489498873,0.4028946111597773,-0.667288473089513,-0.7728811137881995,-0.7575182086310817,-0.2796849658918874,-0.16916890702326892,0.6798330869011706},
                    {-0.5330494734576816,0.04311780642913088,0.1476236493284273,0.7113397896214835,-0.5764496554067198,0.7946376341105776,0.07396544225975532,0.6768557987894985,-0.6268330146521468,-0.3467733819544445},
                    {-0.16904322476136624,-0.7301080831322888,0.43021685783291264,-0.024800415711351276,0.00011931443474111347,0.6948416558978414,0.6737431936315021,0.3055320636803269,0.3103173822684582,0.8940352831759606},
                    {0.5803316868845338,-0.8701101491054464,-0.8996850215187036,0.5108722883225236,-0.44545815797011645,0.3775779527997809,0.4084051243635871,-0.6245136230664206,0.42257753615554905,0.12540996716477437}};

    layer1_weight_t layer1_weight [12][11] = {
                    {0.830610190273001,-0.16910523325801852,0.805614567940032,0.7238363153692542,0.7487453380478264,-0.9682954506756507,0.03645814675319481,-0.08629161021258125,-0.3255398153972857,0.7937001478876293,0.35187487946942086},
                    {-0.363176648256893,0.597817845314156,-0.6048299864745468,0.049545054540131694,0.6154417159363912,0.942599829698205,-0.873512721999415,0.5192675746050643,-0.9862302805904262,0.2584715664120707,-0.029513824701445035},
                    {-0.5390974396696548,0.19884856284073238,0.27106920332033835,0.4172348306938716,-0.06687573434197835,0.17093551778157146,-0.09625019658454459,0.6546264249520046,-0.3937245452445195,-0.09543568792456547,-0.9205243697448493},
                    {-0.41473462064363154,-0.268649881991456,0.6861461148548436,0.47225088020248585,-0.5175787414235367,-0.2985583854859257,0.9506512124023825,0.48053241121606605,-0.18545731452332537,0.4076505163441513,0.6610162787376004},
                    {0.64563020622574,-0.7316316995553953,0.04959007760946155,0.2367751574022363,-0.06913770752188753,-0.6752949784820057,0.39159009758420815,0.6231705522648996,-0.13708163018707697,-0.1916565055416044,-0.71458136658115},
                    {0.5068556079057933,0.2771499217068427,0.8386673492831078,-0.7139397999496404,0.6503270508591834,-0.29005082015775296,0.8785519861752655,0.4443249378112495,-0.3417169426500408,0.7748218650043295,-0.9622449140455973},
                    {0.7567355981562971,0.14817879568615844,0.1459922681867638,-0.010196116181621084,-0.6869873914784783,-0.6125649716341282,-0.8840416090414196,0.6658496077511109,-0.2871866850559799,-0.4658087387336203,0.4303373639362289},
                    {0.7599969314655155,-0.41254104084793175,0.229894719711077,-0.9103783160544447,-0.39440701434699066,0.7982898973494719,0.5719112285350201,0.23707899667809573,0.3312807703820726,0.23418372474624882,0.584329188560393},
                    {-0.867649004859196,-0.692965676916502,-0.8774757728043403,0.6328337604926308,-0.1267664457460862,-0.46986163249018054,0.9571042531773672,0.4192132168068283,-0.5027442138878409,-0.02168973635542293,-0.9107293027369141},
                    {-0.056553396377439835,-0.3796845221493661,0.5802208275403014,-0.5568070671139471,-0.49640125714392624,0.09072273512262297,0.5351409613284945,0.3928412741237213,0.23410800213430139,-0.5544433573993759,-0.6811161587865033},
                    {0.10087453302136584,-0.11571829750158846,0.6546746328684556,0.7599767227445586,0.7787516308711069,0.6040692822250389,-0.07317534341414755,-0.515831519514047,0.8896403263580948,-0.4093337358675422,0.6187538245652986},
                    {0.7324794242346917,-0.6471618594612669,-0.8930144837679708,-0.9482013901843833,0.975121822080629,0.39699331415555794,-0.9704146221190983,-0.9675623868839074,0.4870766496864396,0.30793293114850084,-0.009347139596080245}};

    layer2_weight_t layer2_weight [13][12] = {
                    {0.15428013048769906,0.5633921712731342,0.7977813761055306,-0.13524004481288654,0.6609922969942865,-0.2692068490309578,0.39643678110513036,0.9365136946494292,0.46433070259614984,0.9268569297463769,-0.9520352069506102,0.3040500378632971},
                    {-0.32833728718975697,-0.21368324882021206,-0.9226688733182669,0.8223237071458054,0.6505505257891133,0.19988563121920055,0.012869051310347768,-0.9334438472865139,-0.2702827332308757,0.11406069272170916,-0.33609441719983657,0.08036429338312523},
                    {-0.8698261983299411,-0.1425120186496085,0.5907148538357085,-0.7933784996408229,0.8231570358805729,-0.7477413656768976,0.7880346374569129,-0.7972250082640828,0.11835400405168106,0.09159534484805465,0.08678682706356655,0.26724865136734066},
                    {-0.6471385179859006,-0.6508172431306978,-0.08305216823642958,-0.7252599042924972,-0.09910141941112238,0.04799583934259877,-0.027263066361927546,-0.5826758222485979,-0.2397071941165807,0.6434888471750144,-0.13335338010007836,0.4665547101200618},
                    {-0.5487984946939675,0.7354548343710416,-0.26729696611981657,-0.21316457557184765,0.9519604760654594,0.7862701094687465,-0.5808898282332129,-0.007879610753142252,0.7004923093360138,0.08983539294289367,0.2145320091737799,0.6782599749695395},
                    {-0.03132133653979263,0.00926774518073592,0.6429734000037177,0.9175349735579994,-0.01487200286633028,0.277921268071633,0.1573762781885799,0.9569575353916444,0.8296010885619405,-0.4345307741219855,-0.42354099015067237,0.19158813543125253},
                    {-0.009929934756885528,0.6905486253932576,0.8095868841169511,0.8078485859149056,-0.07734359989404305,-0.4646700139176019,-0.11427452461807186,0.49616610188317956,0.27645406824037844,0.9246164213303216,-0.8247760012883374,0.4552501369191113},
                    {0.42576351065315676,0.8402562872993296,0.5880822768683949,-0.7033217281637105,-0.44828999556299576,-0.4496083548097891,0.06570824130538333,-0.8733671544633721,0.5460983535493509,0.6867949095845365,-0.8519827106756825,-0.09087400629651565},
                    {0.5750831059874268,0.2134836886872531,-0.6066206726939589,0.3625570812937293,0.4656104472810916,-0.6294881467334594,0.796302486669427,0.5438448007845662,0.9254450817814646,0.129269369142629,0.479544905186029,-0.19985887059559415},
                    {-0.41359219430557603,0.8953155532878281,0.8487531045541115,-0.01612713374785879,0.303965593676909,-0.1912483054327183,0.5780224427183325,0.2622082986827323,-0.8217184319688011,-0.5280807875647227,0.9869282562259583,0.8911272085359496},
                    {-0.920402419576545,-0.21289168641967615,0.6796783563798701,-0.5401748879677011,-0.5207645456472203,0.12620656261528174,-0.23372536278824718,-0.6534160489473309,0.3234116972854528,-0.8825846171911265,0.43180228869499016,0.840201319439347},
                    {0.08579444565329708,0.024322859823538767,-0.5139328968615717,-0.8900728042646009,0.3255827431425966,-0.8589535940771214,-0.8418873955336514,0.946242787638033,0.0747317460885435,-0.1867999931076283,-0.35267653375390084,-0.35479178863443983},
                    {0.7046547605536859,-0.40749827355340207,-0.6880786966834935,-0.6912180198640401,0.6021315972069512,0.9592558800697752,-0.7704543299983386,0.11172908569227924,-0.08070520259351599,-0.19803815269763025,-0.1190970472919528,-0.36460169782810525}};

    layer0_bias_t layer0_bias [11] = {-0.4573462113401785,0.8972220397889321,0.05070772259109968,-0.6982698329286454,0.944921441238519,0.4992352882772715,-0.760050717745737,-0.6950488169970701,-0.29804744314918064,-0.0034462269426043246,0.9955759417956269};

    layer1_bias_t layer1_bias [12] = {-0.5605683561111845,0.3284718029076583,0.8012683122542739,-0.11368042412109891,-0.3339536863074457,0.9281358888216398,-0.2691606147598786,0.6561051740135648,-0.8013732229790382,0.05490999000449759,0.5556716855620143,0.7013698715247669};

    layer2_bias_t layer2_bias [13] = {-0.09188100852112213,-0.6339455938032732,0.1047647426737861,-0.17573851028205856,-0.7887139677200059,-0.43420477540728397,-0.9563838526863677,-0.6192311530777663,-0.0999073452960959,0.9672068595718528,-0.25687129481782334,-0.026218022776603567,-0.6618063175538766};

    // INITIALIZE TRUTHS
    truth_t truth [13] = {1.0708538252700497,0.11021508382507306,0.6493419863088022,0.22714079180364044,0.7329861840080493,2.0449903187861525,0.2949527577582357,0.6493411219925496,1.3680542760608727,2.725442748344176,0.3568544249442105,0.17508574689165024,0.9730008159945926};

    layer0_weight_grad_t layer0_weight_grad_real [11][10] = {
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {-0.19560460579844566,-0.11719663866033854,-0.2069341230289627,-0.05104268367735982,-0.10838369128301051,-0.13395420813842898,-0.2342781412202321,-0.07546445312169558,-0.24807415578921427,-0.07255560007625851},
                    {0.048665735935728205,0.029158110292535414,0.05148447985829082,0.012699239648032032,0.026965480072353134,0.033327334467070924,0.05828757512941782,0.018775289739030063,0.06171997488932613,0.018051577362180684},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {-0.8079080014008784,-0.4840586535500046,-0.8547024395235444,-0.21082219607039898,-0.4476584334580257,-0.5532726396425958,-0.9676417591116585,-0.3116917173268516,-1.0246236001691678,-0.2996772474184615},
                    {0.04131172714596111,0.024751950696644466,0.043704523177588626,0.010780223769625818,0.02289065466060408,0.028291152317600668,0.04947958462862576,0.015938105771369494,0.05239330533192438,0.015323755496588033}};

    layer1_weight_grad_t layer1_weight_grad_real [12][11] = {
                    {0.0,-0.7654766662921605,-0.3359905432935972,0.0,0.0,0.0,0.0,0.0,0.0,-0.8744639277688624,-0.6576717688670961},
                    {0.0,-1.6310011987713415,-0.7158950795222999,0.0,0.0,0.0,0.0,0.0,0.0,-1.8632203661828548,-1.401301294546446},
                    {0.0,-1.0664872049350567,-0.4681130479619812,0.0,0.0,0.0,0.0,0.0,0.0,-1.218331833235524,-0.9162898850218647},
                    {0.0,0.5845663894697645,0.2565836261743857,0.0,0.0,0.0,0.0,0.0,0.0,0.6677959544521103,0.5022397524473949},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,-0.07341400172627506,-0.03222359532505172,0.0,0.0,0.0,0.0,0.0,0.0,-0.08386656201259834,-0.06307483755031064},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,-2.2570165753437847,-0.9906719025749859,0.0,0.0,0.0,0.0,0.0,0.0,-2.5783667437894904,-1.9391526206262681},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.27842326471013573,0.12220827635238603,0.0,0.0,0.0,0.0,0.0,0.0,0.3180646940160669,0.23921189117707012},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0}};

    layer2_weight_grad_t layer2_weight_grad_real [13][12] = {
                    {-1.431125593774899,-1.3285770482435457,-0.10778647982375109,-1.4870346698777577,0.0,-2.2295554044714825,0.0,-1.5157449639710985,0.0,0.0,-1.0512514691126442,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {-0.14915941911115885,-0.13847127157981312,-0.011234072528980399,-0.15498655640142775,0.0,-0.23237596368458152,0.0,-0.15797889390702535,0.0,0.0,-0.10956694447689262,0.0},
                    {-0.1078963349306605,-0.10016492948069038,-0.008126307137995023,-0.1121114677094309,0.0,-0.16809206523432282,0.0,-0.11427601254108465,0.0,0.0,-0.07925662227068486,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {-0.5935221905564124,-0.5509928432741806,-0.044701644562594324,-0.6167090285704163,0.0,-0.924650228732435,0.0,-0.6286158777777255,0.0,0.0,-0.4359792582058473,0.0},
                    {-0.950152267759263,-0.8820682830161636,-0.07156155174905894,-0.9872713967012138,0.0,-1.4802454325938808,0.0,-1.0063327223874303,0.0,0.0,-0.697946407853666,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0},
                    {-0.898735193306033,-0.8343355436231068,-0.06768902967115312,-0.9338456368180703,0.0,-1.4001425983437215,0.0,-0.9518754672005952,0.0,0.0,-0.6601773432156298,0.0}};

    layer0_bias_grad_t layer0_bias_grad_real [11] = {-0.0,-0.2738087849495207,0.06812265984660087,0.0,-0.0,-0.0,0.0,-0.0,0.0,-1.1309156413346992,0.05782846353657603};
    layer1_bias_grad_t layer1_bias_grad_real [12] = {-0.6234916908454532,-1.3284737993630458,-0.8686690789555812,0.47613768339584706,-0.0,-0.05979675421037067,-0.0,-1.8383722754655603,-0.0,-0.0,0.22677973049877087,-0.0};
    layer2_bias_grad_t layer2_bias_grad_real [13] = {-1.244130946230439,-0.0,-0.0,-0.0,-0.12966985570320078,-0.09379831501580504,-0.0,-0.0,-0.515971014534073,-0.8260028645230584,-0.0,-0.0,-0.7813040807334648};

    // DECLARE RESULTS
    layer2_post_relu_t y_pred [13];

    layer0_weight_grad_t layer0_weight_grad_pred [11][10];
    layer1_weight_grad_t layer1_weight_grad_pred [12][11];
    layer2_weight_grad_t layer2_weight_grad_pred [13][12];

    layer0_bias_grad_t layer0_bias_grad_pred [11];
    layer1_bias_grad_t layer1_bias_grad_pred [12];
    layer2_bias_grad_t layer2_bias_grad_pred [13];

    // CALL PROJECT FUNCTION
    myproject(
        input,
        layer0_weight,
        layer0_bias,
        layer1_weight,
        layer1_bias,
        layer2_weight,
        layer2_bias,
        y_pred,
        layer0_weight_grad_pred,
        layer0_bias_grad_pred,
        layer1_weight_grad_pred,
        layer1_bias_grad_pred,
        layer2_weight_grad_pred,
        layer2_bias_grad_pred,
        truth
    );

    int count = 0;
    float error = 0;
    float val_real, val_pred;
    FILE* fout;

    // CALCULATE PERCENT ERROR
    if (DEBUG) fout = fopen("/homes/jco1147/hls4training/hls4training/writer_test_projects/test1/grad_results.txt", "w");

    // weight error for layer0
    if (DEBUG) fprintf(fout, "layer0 weight grad\n");

    for (int i = 0; i < 11; i++){
        for (int j = 0; j < 10; j++){

            val_real = (float) layer0_weight_grad_real[i][j];
            val_pred = (float) layer0_weight_grad_pred[i][j];

            if (DEBUG) fprintf(fout, "%f, ", val_pred);

            error += abs((val_real - val_pred)/(val_real + 0.001));
            count += 1;
        }

        if (DEBUG) fprintf(fout, "\n");

    }

    // bias error for layer0
    if (DEBUG) fprintf(fout, "layer0 bias grad\n");

    for (int i = 0; i < 11; i++){

        val_real = (float) layer0_bias_grad_real[i];
        val_pred = (float) layer0_bias_grad_pred[i];
        if (DEBUG) fprintf(fout, "%f, ", val_pred);

        error += abs((val_real - val_pred)/(val_real + 0.001));
        count += 1;
    }

    if (DEBUG) fprintf(fout, "\n");

    // weight error for layer1
    if (DEBUG) fprintf(fout, "layer1 weight grad\n");

    for (int i = 0; i < 12; i++){
        for (int j = 0; j < 11; j++){

            val_real = (float) layer1_weight_grad_real[i][j];
            val_pred = (float) layer1_weight_grad_pred[i][j];

            if (DEBUG) fprintf(fout, "%f, ", val_pred);

            error += abs((val_real - val_pred)/(val_real + 0.001));
            count += 1;
        }

        if (DEBUG) fprintf(fout, "\n");

    }

    // bias error for layer1
    if (DEBUG) fprintf(fout, "layer1 bias grad\n");

    for (int i = 0; i < 12; i++){

        val_real = (float) layer1_bias_grad_real[i];
        val_pred = (float) layer1_bias_grad_pred[i];
        if (DEBUG) fprintf(fout, "%f, ", val_pred);

        error += abs((val_real - val_pred)/(val_real + 0.001));
        count += 1;
    }

    if (DEBUG) fprintf(fout, "\n");

    // weight error for layer2
    if (DEBUG) fprintf(fout, "layer2 weight grad\n");

    for (int i = 0; i < 13; i++){
        for (int j = 0; j < 12; j++){

            val_real = (float) layer2_weight_grad_real[i][j];
            val_pred = (float) layer2_weight_grad_pred[i][j];

            if (DEBUG) fprintf(fout, "%f, ", val_pred);

            error += abs((val_real - val_pred)/(val_real + 0.001));
            count += 1;
        }

        if (DEBUG) fprintf(fout, "\n");

    }

    // bias error for layer2
    if (DEBUG) fprintf(fout, "layer2 bias grad\n");

    for (int i = 0; i < 13; i++){

        val_real = (float) layer2_bias_grad_real[i];
        val_pred = (float) layer2_bias_grad_pred[i];
        if (DEBUG) fprintf(fout, "%f, ", val_pred);

        error += abs((val_real - val_pred)/(val_real + 0.001));
        count += 1;
    }

    if (DEBUG) fprintf(fout, "\n");

    error = error / count;
    printf("Test Complete: Average Percent Error across %d gradients is %2.3f%\n", count, error * 100);
    if (DEBUG) fclose(fout);

    return 0;

}